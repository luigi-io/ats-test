name: Mass Payout Publish

on:
  # Manual trigger with dry-run option
  workflow_dispatch:
    inputs:
      dry-run-enabled:
        description: "Run npm publish with dry-run flag"
        required: false
        type: boolean
        default: false

  # Tag push trigger - simpler and automatic (no need to create GitHub release)
  push:
    tags:
      - "v*-mp"
      - "v*-MP"

defaults:
  run:
    shell: bash

permissions:
  contents: read
  id-token: write

jobs:
  mass-payout:
    name: Publish Mass Payout Packages
    runs-on: token-studio-linux-large
    # Only run if manual trigger OR tag push (already filtered by v*-mp pattern)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.20.0
          registry-url: https://registry.npmjs.org

      - name: Create .npmrc file
        run: |
          cat << 'EOF' > .npmrc
          //registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}
          EOF

      - name: Install dependencies
        run: npm ci

      - name: Install NestJS CLI globally
        run: npm install -g @nestjs/cli

      - name: Build Mass Payout packages
        run: npm run mass-payout:build

      - name: Publish Mass Payout packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          DRY_RUN: ${{ inputs.dry-run-enabled }}
        run: |
          for package_dir in packages/mass-payout/*/; do
            if [ -d "${package_dir}" ] && [ -f "${package_dir}package.json" ]; then
              package_name=$(basename "${package_dir}")
              echo "ðŸ“¦ Processing Mass Payout package: ${package_name}"

              cd "${package_dir}"

              if ! node -p "require('./package.json').private || false" | grep -q "true"; then
                PUBLISH_ARGS=("--access=restricted")
                if [[ "${DRY_RUN}" == "true" ]]; then
                  PUBLISH_ARGS+=("--dry-run")
                  echo "ðŸ” DRY RUN MODE: Would publish @hashgraph/mass-payout-${package_name}"
                fi

                if ! npm publish "${PUBLISH_ARGS[@]}"; then
                  echo "âŒ Failed to publish package: ${package_name}"
                  echo "ðŸ“‹ Package info:" && cat package.json | jq '.name, .version'
                  exit 1
                fi
              else
                echo "â­ï¸  Skipping private package: ${package_name}"
              fi

              cd - > /dev/null
            fi
          done

  # Summary job to report results
  summary:
    name: Publish Summary
    runs-on: token-studio-linux-large
    needs:
      - mass-payout
    if: ${{ always() }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Report Results
        run: |
          echo "## Mass Payout Publish Results" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Package Type | Status |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| --- | --- |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Mass Payout | ${{ needs.mass-payout.result }} |" >> "${GITHUB_STEP_SUMMARY}"

          if [[ "${{ inputs.dry-run-enabled }}" == "true" ]]; then
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "ðŸ” **DRY RUN MODE** - No packages were actually published" >> "${GITHUB_STEP_SUMMARY}"
          fi

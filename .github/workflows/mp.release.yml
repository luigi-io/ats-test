name: Mass Payout Release

on:
  # Manual trigger with preview/release option
  workflow_dispatch:
    inputs:
      release-type:
        description: "Type of release to perform"
        required: true
        type: choice
        options:
          - preview # Show what would be released (dry-run)
          - release # Full production release
        default: "preview"

defaults:
  run:
    shell: bash

permissions:
  contents: write # For creating commits and tags
  id-token: write

jobs:
  mp-release:
    name: Create Mass Payout Release
    runs-on: token-studio-linux-large

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Use GitHub App token to bypass branch protection
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.20.0

      - name: Install dependencies
        run: npm ci

      - name: Validate Mass Payout changesets exist
        id: validate
        run: |
          echo "ðŸ“‹ Getting changeset status..."
          npx changeset status --output=changeset-status.json

          MP_PACKAGES_TO_BUMP=$(jq -r '.releases[] | select(.name | test("@hashgraph/mass-payout")) | .name' changeset-status.json | wc -l)

          echo "mp-packages-to-bump=${MP_PACKAGES_TO_BUMP}" >> "${GITHUB_OUTPUT}"

          if [ "${MP_PACKAGES_TO_BUMP}" -eq 0 ]; then
            echo "âŒ No Mass Payout packages found to be bumped"
            echo "ðŸ“‹ Current changeset status:"
            npx changeset status
            exit 1
          fi

          echo "âœ… Found ${MP_PACKAGES_TO_BUMP} Mass Payout package(s) ready for release"

          echo "ðŸ“¦ Mass Payout packages to be released:"
          jq -r '.releases[] | select(.name | test("@hashgraph/mass-payout")) | "  - \(.name) (\(.oldVersion) â†’ \(.newVersion))"' changeset-status.json

      - name: Preview Mass Payout release
        if: ${{ inputs.release-type == 'preview' }}
        run: |
          echo "ðŸ” PREVIEW MODE - What would be released for Mass Payout packages:"
          echo ""
          echo "ðŸ“‹ Current changeset status:"
          npx changeset status
          echo ""
          echo "ðŸš« ATS packages would be ignored during Mass Payout release"
          echo "ðŸŽ¯ Only @hashgraph/mass-payout* packages would be processed"
          echo ""
          echo "To proceed with actual release, run this workflow with 'release' option."

      - name: Version Mass Payout packages
        if: ${{ inputs.release-type == 'release' }}
        run: |
          echo "ðŸš€ Releasing Mass Payout packages only (ignoring ATS packages)"

          npx changeset version --ignore "@hashgraph/asset-tokenization-*"

          if [[ -n "$(git status --porcelain)" ]]; then
            echo "âœ… Version bump completed for Mass Payout packages"
          else
            echo "âŒ No version changes detected"
            exit 1
          fi

      - name: Commit version changes
        if: ${{ inputs.release-type == 'release' }}
        run: |
          git add .

          if git commit --signoff -S -m "chore: release Mass Payout packages"; then
            echo "âœ… Version changes committed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Create Mass Payout release
        id: create-mp-release-tag
        if: ${{ inputs.release-type == 'release' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MP_VERSION=$(node -p "require('./packages/mass-payout/core/package.json').version" 2>/dev/null || echo "1.0.0")
          TAG_NAME="v${MP_VERSION}-mp"
          echo "ðŸ“¦ Creating Mass Payout release: ${TAG_NAME}"
          git tag -s -a "${TAG_NAME}" -m "Creating Mass Payout Release with tag: ${TAG_NAME}"
          git push origin "${TAG_NAME}"

          echo "release-tag=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Create github release
        if: ${{ inputs.release-type == 'release' }}
        uses: step-security/release-action@03a57407052f15d1537fd5469a6fbbc536aba326 # v1.20.0
        with:
          tag: ${{ steps.create-mp-release-tag.outputs.release-tag }}
          prerelease: false
          draft: false
          generateReleaseNotes: true
          skipIfReleaseExists: true

      - name: Release Summary
        if: ${{ always() }}
        run: |
          if [ "${{ inputs.release-type }}" = "preview" ]; then
            echo "## ðŸ” Mass Payout Release Preview Completed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Preview mode was selected. No actual release was created." >> "${GITHUB_STEP_SUMMARY}"
          elif [ "${{ job.status }}" = "success" ]; then
            MP_VERSION=$(node -p "require('./packages/mass-payout/core/package.json').version" 2>/dev/null || echo "unknown")
            echo "## âœ… Mass Payout Release v${MP_VERSION} Completed Successfully" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Package | Status |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| --- | --- |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Mass Payout Packages | âœ… Released |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| GitHub Release | âœ… Created |" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**Next Steps:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "- NPM publishing will be triggered automatically via mp.publish.yml" >> "${GITHUB_STEP_SUMMARY}"
            echo "- ATS packages were ignored and remain available for separate release" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "## âŒ Mass Payout Release Failed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Check the logs above for details on what went wrong." >> "${GITHUB_STEP_SUMMARY}"
          fi

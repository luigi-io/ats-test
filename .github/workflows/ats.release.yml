name: ATS Release

on:
  # Manual trigger with preview/release option
  workflow_dispatch:
    inputs:
      release-type:
        description: "Type of release to perform"
        required: true
        type: choice
        options:
          - preview # Show what would be released (dry-run)
          - release # Full production release
        default: "preview"

defaults:
  run:
    shell: bash

permissions:
  contents: write # For creating commits and tags
  id-token: write

jobs:
  ats-release:
    name: Create ATS Release
    runs-on: token-studio-linux-large

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Use GitHub App token to bypass branch protection
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: v22.20.0

      - name: Install dependencies
        run: npm ci

      - name: Validate ATS changesets exist
        id: validate
        run: |
          echo "ðŸ“‹ Getting changeset status..."
          npx changeset status --output=changeset-status.json

          ATS_PACKAGES_TO_BUMP=$(jq -r '.releases[] | select(.name | test("@hashgraph/asset-tokenization-")) | .name' changeset-status.json | wc -l)

          echo "ats-packages-to-bump=${ATS_PACKAGES_TO_BUMP}" >> "${GITHUB_OUTPUT}"

          if [ "${ATS_PACKAGES_TO_BUMP}" -eq 0 ]; then
            echo "âŒ No ATS packages found to be bumped"
            echo "ðŸ“‹ Current changeset status:"
            npx changeset status
            exit 1
          fi

          echo "âœ… Found ${ATS_PACKAGES_TO_BUMP} ATS package(s) ready for release"

          echo "ðŸ“¦ ATS packages to be released:"
          jq -r '.releases[] | select(.name | test("@hashgraph/asset-tokenization-")) | "  - \(.name) (\(.oldVersion) â†’ \(.newVersion))"' changeset-status.json

      - name: Preview ATS release
        if: ${{ inputs.release-type == 'preview' }}
        run: |
          echo "ðŸ” PREVIEW MODE - What would be released for ATS packages:"
          echo ""
          echo "ðŸ“‹ Current changeset status:"
          npx changeset status
          echo ""
          echo "ðŸš« Mass Payout packages would be ignored during ATS release"
          echo "ðŸŽ¯ Only @hashgraph/asset-tokenization-* packages would be processed"
          echo ""
          echo "To proceed with actual release, run this workflow with 'release' option."

      - name: Version ATS packages
        if: ${{ inputs.release-type == 'release' }}
        run: |
          echo "ðŸš€ Releasing ATS packages only (ignoring Mass Payout packages)"

          # Ignore all mass-payout packages (they use @mass-payout/* namespace)
          npx changeset version \
            --ignore "@mass-payout/contracts" \
            --ignore "@mass-payout/sdk" \
            --ignore "@mass-payout/backend" \
            --ignore "@mass-payout/frontend"

          if [[ -n "$(git status --porcelain)" ]]; then
            echo "âœ… Version bump completed for ATS packages"
          else
            echo "âŒ No version changes detected"
            exit 1
          fi

      - name: Commit version changes
        if: ${{ inputs.release-type == 'release' }}
        run: |
          git add .

          if git commit --signoff -S -m "chore: release ATS packages"; then
            echo "âœ… Version changes committed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Create ATS release
        id: create-release-tag
        if: ${{ inputs.release-type == 'release' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ATS_VERSION=$(node -p "require('./packages/ats/contracts/package.json').version")
          TAG_NAME="v${ATS_VERSION}-ats"
          echo "ðŸ“¦ Creating ATS release tag: ${TAG_NAME}"
          git tag "${TAG_NAME}"
          git push origin "${TAG_NAME}"

          echo "tag-name=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Create github release
        if: ${{ inputs.release-type == 'release' }}
        uses: step-security/release-action@03a57407052f15d1537fd5469a6fbbc536aba326 # v1.20.0
        with:
          tag: ${{ steps.create-release-tag.outputs.tag-name }}
          prerelease: false
          draft: false
          generateReleaseNotes: true
          skipIfReleaseExists: true

      - name: Release Summary
        if: always()
        run: |
          if [ "${{ inputs.release-type }}" = "preview" ]; then
            echo "## ðŸ” ATS Release Preview Completed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Preview mode was selected. No actual release was created." >> "${GITHUB_STEP_SUMMARY}"
          elif [ "${{ job.status }}" = "success" ]; then
            ATS_VERSION=$(node -p "require('./packages/ats/contracts/package.json').version" 2>/dev/null || echo "unknown")
            echo "## âœ… ATS Release v${ATS_VERSION} Completed Successfully" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Package | Status |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| --- | --- |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| ATS Contracts | âœ… Released |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| ATS SDK | âœ… Released |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| GitHub Release | âœ… Created |" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**Next Steps:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "- NPM publishing will be triggered automatically via ats.publish.yml" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Mass Payout packages were ignored and remain available for separate release" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "## âŒ ATS Release Failed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Check the logs above for details on what went wrong." >> "${GITHUB_STEP_SUMMARY}"
          fi
